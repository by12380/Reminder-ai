var createError = require('http-errors');
var express = require('express');
var path = require('path');
var logger = require('morgan');
var session = require("express-session");
const flash = require('connect-flash');
const passport = require('passport');
const mongoose = require('mongoose');
const fawn = require('fawn');
const nodeCleanup = require('node-cleanup');

mongoose.Promise = global.Promise;

var indexRouter = require('./routes/index');
var reminderRouter = require('./routes/reminder');



const { DATABASE_URL, PORT } = require('./config');
const { initLocalLoginInAndRegisterStrategies } = require('./passport-config');
const Notification = require('./models/notifications');
const { notificationScheduler } = require('./notificationScheduler');

const User = require('./models/user');

const app = express();
fawn.init(mongoose);

// view engine setup
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');

app.use(logger('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));
app.use(session({ secret: "reminder-app", resave: false, saveUninitialized: false }));
app.use(passport.initialize());
app.use(passport.session());
app.use(flash());


app.use('/', indexRouter);
app.use('/reminder', reminderRouter);

// catch 404 and forward to error handler
app.use(function(req, res, next) {
  next(createError(404));
});

// error handler
app.use(function(err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render('error');
});

//Initiate local strategy for use by Passport
initLocalLoginInAndRegisterStrategies(passport);

//Configure Passport authenticated session persistence.
passport.serializeUser(function(user, done) {
  done(null, user.id);
});

passport.deserializeUser(function(id, done) {
  User.findById(id, function(err, user) {
    done(err, user);
  });
});

//Load scheduler on start up
Notification.find().then((notifications) => {
  notificationScheduler.addAll(notifications);
})


let server;
let io;

// this function connects to our database, then starts the server
function runServer(databaseUrl, port = PORT) {
  return new Promise((resolve, reject) => {
    mongoose.connect(databaseUrl, err => {
      if (err) {
        return reject(err);
      }
      server = app.listen(port, () => {
        console.log(`Your app is listening on port ${port}`);
        resolve();
      })
      .on('error', err => {
        mongoose.disconnect();
        reject(err);
      });
      //Initialize socket io
      io = require('socket.io')(server);
    });
  });
}

// this function closes the server, and returns a promise. we'll
// use it in our integration tests later.
function closeServer() {
  return mongoose.disconnect().then(() => {
    return new Promise((resolve, reject) => {
      console.log('Closing server');
      server.close(err => {
        if (err) {
          return reject(err);
        }
        resolve();
      });
    });
  });
}

function getSocketIO() {
  return io;
}

nodeCleanup(function (exitCode, signal) {
  notificationScheduler.removeAll();
});

// if server.js is called directly (aka, with `node server.js`), this block
// runs. but we also export the runServer command so other code (for instance, test code) can start the server as needed.
if (require.main === module) {
  runServer(DATABASE_URL).catch(err => console.error(err));
}

module.exports = { runServer, app, closeServer, getSocketIO };
